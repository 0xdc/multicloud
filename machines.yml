---
- hosts: localhost
  tasks:

  - os_server:
      cloud: "{{ cloud_provider }}"
      region_name: "{{ cloud_region }}"

      name: "{{ server_name }}"
      meta: "role={{ server_name }}"
      flavor: "{{ flavor }}"
      image: "{{ image }}"

      key_name: "{{ ansible_hostname }}"
    register: server


  - cloudflare_dns:
      account_email: "{{ cf_account }}"
      account_api_token: "{{ cf_apikey }}"

      state: present
      zone: "{{ zone }}"

      # solo affects these two attrs
      solo: yes
      record: "{{ server_name }}"
      type: "{{ item.type }}"

      value: "{{ item.value }}"
    with_items:
    - { type: A,    value: "{{ server.openstack.accessIPv4 }}" }
    - { type: AAAA, value: "{{ server.openstack.accessIPv6 }}" }


  vars_files:
  - config.yml
  - "{{ cloud_provider }}.yml"
